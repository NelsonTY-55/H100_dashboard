<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB 設定 - 系統配置</title>
    <link href="/static/css/vendor/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/vendor/fontawesome.min.css" rel="stylesheet">
    <style>
        .setting-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 30px;
        }
        .card {
            transition: transform 0.2s;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-1px);
        }
        .preview-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .device-info-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background-color: #28a745;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* 側邊欄樣式 */
        .sidebar-collapsible {
            width: 220px;
            min-width: 60px;
            max-width: 220px;
            left: 0;
            top: 0;
            z-index: 1040;
            background: #2563eb;
            color: #fff;
            transition: width 0.3s cubic-bezier(.4,0,.2,1);
            box-shadow: 2px 0 10px rgba(0,0,0,0.04);
        }
        .sidebar-collapsible.collapsed {
            width: 60px !important;
        }
        .sidebar-collapsible .sidebar-header {
            background: #1e40af;
            border-bottom: 1px solid #3b82f6;
        }
        .sidebar-collapsible .sidebar-logo {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.08);
            border-radius: 10px;
            font-size: 1.3rem;
        }
        .sidebar-collapsible .sidebar-title {
            font-size: 1.15rem;
            transition: opacity 0.2s;
        }
        .sidebar-collapsible.collapsed .sidebar-title,
        .sidebar-collapsible.collapsed .sidebar-link-text {
            opacity: 0;
            width: 0;
            overflow: hidden;
            pointer-events: none;
        }
        .sidebar-collapsible .nav-link {
            color: #fff !important;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border-radius: 0 30px 30px 0;
            margin-bottom: 0.2rem;
            transition: background 0.2s, color 0.2s;
        }
        .sidebar-collapsible .nav-link.active, .sidebar-collapsible .nav-link:hover {
            background: linear-gradient(90deg, #60a5fa 0%, #818cf8 100%);
            color: #fff !important;
        }
        .sidebar-collapsible .nav-link i {
            min-width: 22px;
            text-align: center;
        }
        body {
            padding-left: 220px;
            transition: padding-left 0.3s cubic-bezier(.4,0,.2,1);
        }
        .sidebar-collapsible.collapsed ~ *:not(.sidebar-collapsible) {
            transition: margin-left 0.3s cubic-bezier(.4,0,.2,1);
        }
        @media (max-width: 991.98px) {
            body {
                padding-left: 0 !important;
            }
            .sidebar-collapsible {
                left: -220px;
            }
            .sidebar-collapsible.show {
                left: 0;
            }
        }
    </style>
</head>
<body class="bg-light">
    <!-- Side Navigation -->
    <div id="sidebar" class="sidebar-collapsible bg-primary text-white position-fixed h-100">
        <div class="sidebar-header d-flex align-items-center justify-content-between px-3 py-3">
            <div class="d-flex align-items-center">
                <span class="sidebar-logo d-flex align-items-center justify-content-center me-2">
                    <i class="fas fa-columns fa-lg"></i>
                </span>
                <span class="sidebar-title fw-bold" id="sidebarTitle">H100 Dashboard</span>
            </div>
            <button class="btn btn-sm btn-light shadow-none ms-2" id="sidebarCollapseBtn" aria-label="收合選單" style="border-radius:50%;"><i class="fas fa-bars"></i></button>
        </div>
        <ul class="nav flex-column pt-2">
            <li class="nav-item">
                <a class="nav-link d-flex align-items-center text-white" href="/">
                    <i class="fas fa-home me-2"></i> <span class="sidebar-link-text">首頁</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link d-flex align-items-center text-white" href="/dashboard">
                    <i class="fas fa-tachometer-alt me-2"></i> <span class="sidebar-link-text">監控中心</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link d-flex align-items-center text-white active" href="/db-setting">
                    <i class="fas fa-cog me-2"></i> <span class="sidebar-link-text">設備機台設定</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link d-flex align-items-center text-white" href="/11">
                    <i class="fas fa-chart-area me-2"></i> <span class="sidebar-link-text">儀錶板總覽</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link d-flex align-items-center text-white" href="/config-summary">
                    <i class="fas fa-list-alt me-2"></i> <span class="sidebar-link-text">配置摘要</span>
                </a>
            </li>
        </ul>
    </div>

    <div class="setting-header py-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="mb-0"><i class="fas fa-cogs me-2"></i>DB 設定</h1>
                    <p class="mb-0 opacity-75">設定設備資訊與系統參數</p>
                </div>
                <div class="col-auto">
                    <span id="current-time" class="badge bg-light text-dark fs-6"></span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 重定向提示 -->
        {% if redirect_to_dashboard %}
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>需要完成設備設定</strong> - 您必須先設定設備資訊才能使用系統監控儀表板。
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- 設備資訊設定 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-microchip me-2"></i>設備資訊設定</h5>
                    </div>
                    <div class="card-body">
                        <form id="deviceSettingForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="deviceName" class="form-label">
                                            <i class="fas fa-tag me-1"></i>廠區 <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="deviceName" 
                                               placeholder="請輸入廠區（例如：生產線A-1）" 
                                               maxlength="50" required>
                                        <div class="form-text">設備名稱將顯示在儀表板標題中，最多50個字元</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="deviceLocation" class="form-label">
                                            <i class="fas fa-map-marker-alt me-1"></i>設備位置
                                        </label>
                                        <input type="text" class="form-control" id="deviceLocation" 
                                               placeholder="請輸入設備位置（例如：廠房B-2樓）"
                                               maxlength="100">
                                        <div class="form-text">選填，用於設備識別和管理</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-cube me-1"></i>設備型號
                                        </label>
                                        <div class="form-text mb-2">
                                            <span id="channelInfo">請先選擇 MAC ID 以載入頻道資訊</span>
                                        </div>
                                        <div class="row g-2" id="deviceModelContainer">
                                            <!-- 動態生成的頻道輸入欄位將在這裡顯示 -->
                                            <div class="col-12 text-center text-muted py-3">
                                                <i class="fas fa-info-circle me-2"></i>請先選擇設備序號 (MAC ID) 以載入頻道配置
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="deviceSerial" class="form-label">
                                            <i class="fas fa-barcode me-1"></i>設備序號 (MAC ID)
                                        </label>
                                        <div class="input-group">
                                            <select class="form-select" id="deviceSerial">
                                                <option value="">請選擇 MAC ID</option>
                                            </select>
                                            <button class="btn btn-outline-secondary" type="button" onclick="refreshMacIdList()">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            從 UART 接收到的 MAC ID 中選擇
                                            <span id="macIdStatus" class="text-muted ms-2"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="deviceDescription" class="form-label">
                                    <i class="fas fa-align-left me-1"></i>設備描述
                                </label>
                                <textarea class="form-control" id="deviceDescription" rows="3" 
                                          placeholder="請輸入設備的詳細描述或備註"
                                          maxlength="500"></textarea>
                                <div class="form-text">選填，最多500個字元</div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button type="button" class="btn btn-outline-secondary me-2" onclick="resetForm()">
                                        <i class="fas fa-undo me-1"></i>重置
                                    </button>
                                    <button type="button" class="btn btn-success me-2" onclick="previewSettings()">
                                        <i class="fas fa-eye me-1"></i>預覽
                                    </button>
                                </div>
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-1"></i>儲存設定
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 預覽區域 -->
        <div class="row mb-4" id="previewSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-eye me-2"></i>設定預覽</h5>
                    </div>
                    <div class="card-body">
                        <div class="preview-section">
                            <h6 class="mb-3">儀表板標題預覽：</h6>
                            <div class="device-info-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h4 class="mb-0">
                                            <i class="fas fa-tachometer-alt me-2"></i>
                                            <span id="previewDeviceName">未設定廠區</span> - Flask Dashboard
                                        </h4>
                                        <p class="mb-0 opacity-75">
                                            <span class="status-indicator"></span>
                                            系統監控與應用程式狀態
                                            <span id="previewLocation"></span>
                                        </p>
                                    </div>
                                    <div class="text-end">
                                        <small>即時狀態</small>
                                        <div class="fw-bold" id="previewTime">--</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <h6>設備詳細資訊：</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <strong>廠區：</strong><br>
                                        <span id="previewNameDetail">未設定</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>設備位置：</strong><br>
                                        <span id="previewLocationDetail">未設定</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>設備型號：</strong><br>
                                        <span id="previewModelDetail">未設定</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>設備序號：</strong><br>
                                        <span id="previewSerialDetail">未設定</span>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <strong>設備描述：</strong><br>
                                        <span id="previewDescriptionDetail">未設定</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 快速導航 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-compass me-2"></i>快速導航</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button class="btn btn-outline-primary w-100 mb-2" onclick="goToDashboard()" disabled id="dashboardBtn">
                                    <i class="fas fa-tachometer-alt me-2"></i>前往儀表板
                                </button>
                                <small class="text-muted">需先儲存設定才能前往</small>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-success w-100 mb-2" onclick="refreshMacIdList()">
                                    <i class="fas fa-sync-alt me-2"></i>更新 MAC ID
                                </button>
                                <small class="text-muted">重新載入UART接收的MAC ID</small>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-info w-100 mb-2" onclick="loadDefaultSettings()">
                                    <i class="fas fa-magic me-2"></i>載入預設設定
                                </button>
                                <small class="text-muted">使用系統預設的設備設定</small>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-warning w-100 mb-2" onclick="exportSettings()">
                                    <i class="fas fa-download me-2"></i>匯出設定
                                </button>
                                <small class="text-muted">將設定匯出為檔案備份</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 調試面板 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#debugPanel" style="cursor: pointer;">
                        <h6 class="mb-0">
                            <i class="fas fa-bug me-2"></i>調試面板
                            <small class="text-muted ms-2">(點擊展開/收合)</small>
                        </h6>
                    </div>
                    <div class="collapse" id="debugPanel">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-info-circle me-2"></i>API 狀態</h6>
                                    <div id="debugApiStatus" class="text-muted">點擊"測試 UART"按鈕獲取狀態</div>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-database me-2"></i>最近的 API 響應</h6>
                                    <pre id="debugApiResponse" class="text-muted small" style="max-height: 200px; overflow-y: auto;">無響應數據</pre>
                                </div>
                            </div>
                            
                            <!-- 樹梅派配置區域 -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6><i class="fas fa-network-wired me-2"></i>樹梅派連接配置</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group mb-2">
                                                <label for="raspberryPiHost" class="form-label">樹梅派 IP 地址</label>
                                                <input type="text" class="form-control form-control-sm" id="raspberryPiHost" 
                                                       placeholder="例如: 192.168.1.100" value="192.168.1.100">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group mb-2">
                                                <label for="raspberryPiPort" class="form-label">端口</label>
                                                <input type="number" class="form-control form-control-sm" id="raspberryPiPort" 
                                                       placeholder="5000" value="5000" min="1" max="65535">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-group mb-2">
                                                <label class="form-label">&nbsp;</label>
                                                <div>
                                                    <button class="btn btn-primary btn-sm" onclick="saveRaspberryPiConfig()">
                                                        <i class="fas fa-save me-1"></i>保存
                                                    </button>
                                                    <button class="btn btn-outline-secondary btn-sm ms-1" onclick="testRaspberryPiConnection()">
                                                        <i class="fas fa-plug me-1"></i>測試
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="raspberryPiStatus" class="text-muted small">
                                        <i class="fas fa-info-circle"></i> 配置樹梅派 IP 地址以獲取即時 MAC ID 數據
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6><i class="fas fa-list me-2"></i>MAC ID 狀態</h6>
                                    <div id="debugMacIds" class="text-muted">尚未載入 MAC ID</div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button class="btn btn-sm btn-primary me-2" onclick="debugMacIdApi()">
                                        <i class="fas fa-bug me-1"></i>調試 MAC ID API
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="loadMacIdList()">
                                        <i class="fas fa-sync me-1"></i>重新載入 MAC ID
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/vendor/bootstrap.bundle.min.js"></script>
    <script>
        // 頻道配置 - 只顯示頻道 0-6 供用戶設定設備型號（頻道 7 為電池電壓，系統自動處理）
        let CHANNEL_CONFIG = {
            MIN_CHANNEL: 0,    // 最小頻道號
            MAX_CHANNEL: 6,    // 最大頻道號（用戶可設定的）
            CURRENT_CHANNELS: [] // 當前實際可用的頻道（只包含 0-6）
        };
        
        // 獲取當前實際可用的頻道列表
        function getCurrentChannels() {
            return CHANNEL_CONFIG.CURRENT_CHANNELS.length > 0 ? 
                   CHANNEL_CONFIG.CURRENT_CHANNELS : 
                   getDefaultChannels();
        }
        
        // 獲取預設頻道列表（0-6）
        function getDefaultChannels() {
            const channels = [];
            for (let i = CHANNEL_CONFIG.MIN_CHANNEL; i <= CHANNEL_CONFIG.MAX_CHANNEL; i++) {
                channels.push(i.toString());
            }
            return channels;
        }
        
        // 根據 MAC ID 載入頻道資訊
        async function loadChannelsForMacId(macId) {
            if (!macId) {
                // 如果沒有選擇 MAC ID，顯示提示資訊
                displayChannelPlaceholder();
                return;
            }
            
            try {
                document.getElementById('channelInfo').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>載入頻道資訊中...';
                
                // 創建 AbortController 來處理超時
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000); // 8秒超時
                
                // 使用相對路徑
                const response = await fetch(`/api/uart/mac-channels/${macId}`, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('頻道 API 響應:', data);
                    
                    if (data.success) {
                        let channels = [];
                        
                        // 檢查API返回的數據格式
                        if (data.data && Array.isArray(data.data)) {
                            // 從時間序列數據中提取頻道列表
                            const channelSet = new Set();
                            data.data.forEach(dataPoint => {
                                const channel = dataPoint.channel;
                                if (channel >= 0 && channel <= 6) {
                                    channelSet.add(channel);
                                }
                            });
                            channels = Array.from(channelSet).sort((a, b) => a - b);
                        } else if (data.channels && Array.isArray(data.channels)) {
                            // 新格式：直接有 channels 陣列
                            channels = data.channels.filter(ch => ch >= 0 && ch <= 6);
                        } else if (data.data && data.data.channels && Array.isArray(data.data.channels)) {
                            // 舊格式：從 data.channels 提取
                            channels = data.data.channels
                                .map(ch => ch.channel)
                                .filter(ch => ch >= 0 && ch <= 6);
                        }
                        
                        if (channels.length > 0) {
                            // 更新頻道配置
                            CHANNEL_CONFIG.CURRENT_CHANNELS = channels.map(ch => ch.toString());
                            
                            // 動態生成頻道輸入欄位（只顯示 0-6）
                            generateChannelInputs(channels);
                            
                            // 更新提示資訊
                            const dataSource = data.data_source || '未知來源';
                            const statusMsg = `已載入 ${channels.length} 個設備型號頻道: ${channels.join(', ')} (來源: ${dataSource})`;
                            
                            document.getElementById('channelInfo').innerHTML = 
                                `<i class="fas fa-check-circle text-success me-2"></i>${statusMsg}`;
                        } else {
                            console.warn(`MAC ID ${macId} 沒有找到有效頻道（0-6），使用預設配置`);
                            CHANNEL_CONFIG.CURRENT_CHANNELS = getDefaultChannels();
                            generateChannelInputs(getDefaultChannels().map(ch => parseInt(ch)));
                            document.getElementById('channelInfo').innerHTML = 
                                `<i class="fas fa-exclamation-triangle text-warning me-2"></i>該 MAC ID 沒有有效頻道（0-6），使用預設配置`;
                        }
                    } else {
                        throw new Error(data.message || '未知錯誤');
                    }
                } else {
                    throw new Error(`HTTP ${response.status} - ${response.statusText}`);
                }
            } catch (error) {
                console.error('載入頻道資訊失敗:', error);
                
                let errorMessage = '載入頻道資訊失敗';
                if (error.name === 'AbortError') {
                    errorMessage = '頻道資訊載入超時';
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = '無法連接到伺服器載入頻道資訊';
                } else {
                    errorMessage = `載入頻道資訊失敗: ${error.message}`;
                }
                
                // 載入失敗時使用預設配置
                CHANNEL_CONFIG.CURRENT_CHANNELS = getDefaultChannels();
                generateChannelInputs(getDefaultChannels().map(ch => parseInt(ch)));
                document.getElementById('channelInfo').innerHTML = 
                    `<i class="fas fa-exclamation-triangle text-danger me-2"></i>${errorMessage}，使用預設配置`;
            }
        }
        
        // 動態生成頻道輸入欄位
        function generateChannelInputs(channels) {
            const container = document.getElementById('deviceModelContainer');
            container.innerHTML = ''; // 清空容器
            
            // 根據頻道數量決定每行顯示的欄位數
            let colClass = 'col-4'; // 預設每行3個
            if (channels.length <= 2) {
                colClass = 'col-6'; // 1-2個頻道時每行2個
            } else if (channels.length <= 4) {
                colClass = 'col-3'; // 3-4個頻道時每行4個
            } else if (channels.length <= 6) {
                colClass = 'col-4'; // 5-6個頻道時每行3個
            } else {
                colClass = 'col-3'; // 7個以上頻道時每行4個
            }
            
            channels.forEach(channel => {
                const channelDiv = document.createElement('div');
                channelDiv.className = colClass;
                channelDiv.innerHTML = `
                    <label for="deviceModel${channel}" class="form-label small">頻道 ${channel}</label>
                    <input type="text" class="form-control" id="deviceModel${channel}" 
                        placeholder="頻道${channel}型號" maxlength="50">
                `;
                container.appendChild(channelDiv);
            });
        }
        
        // 顯示頻道佔位符
        function displayChannelPlaceholder() {
            const container = document.getElementById('deviceModelContainer');
            container.innerHTML = `
                <div class="col-12 text-center text-muted py-3">
                    <i class="fas fa-info-circle me-2"></i>請先選擇設備序號 (MAC ID) 以載入頻道配置
                </div>
            `;
            document.getElementById('channelInfo').innerHTML = '請先選擇 MAC ID 以載入頻道資訊';
            CHANNEL_CONFIG.CURRENT_CHANNELS = [];
        }
        // 更新時間顯示
        function updateTime() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            document.getElementById('current-time').textContent = now.toLocaleString('zh-TW', options);
            document.getElementById('previewTime').textContent = now.toLocaleString('zh-TW', options);
        }

        // 載入現有設定
        async function loadExistingSettings() {
            try {
                // 檢查 URL 是否包含 mac_id 參數
                const urlParams = new URLSearchParams(window.location.search);
                const targetMacId = urlParams.get('mac_id');
                
                if (targetMacId) {
                    // 如果有指定 MAC ID，先載入所有設備資訊
                    console.log(`正在載入指定設備的設定: ${targetMacId}`);
                    await loadDeviceByMacId(targetMacId);
                } else {
                    // 沒有指定 MAC ID，載入一般設定
                    const response = await fetch('/api/device-settings');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            document.getElementById('deviceName').value = data.settings.device_name || '';
                            document.getElementById('deviceLocation').value = data.settings.device_location || '';
                            document.getElementById('deviceDescription').value = data.settings.device_description || '';
                            
                            // 取得儲存的 MAC ID
                            const deviceSerial = data.settings.device_serial || '';
                            
                            // 如果有 MAC ID，需要確保選項列表載入完成後再設定
                            if (deviceSerial) {
                                // 等待 MAC ID 選項列表載入完成後再設定選中值
                                setTimeout(() => {
                                    const selectElement = document.getElementById('deviceSerial');
                                    // 檢查該 MAC ID 是否在選項列表中
                                    const option = Array.from(selectElement.options).find(opt => opt.value === deviceSerial);
                                    if (option) {
                                        selectElement.value = deviceSerial;
                                        console.log('已設定儲存的 MAC ID:', deviceSerial);
                                        // 載入該 MAC ID 的頻道資訊
                                        loadChannelsForMacId(deviceSerial).then(() => {
                                            // 等待頻道載入完成後，填入型號
                                            setTimeout(() => {
                                                const deviceModel = data.settings.device_model || '';
                                                if (typeof deviceModel === 'object') {
                                                    // 新格式：多頻道對象
                                                    getCurrentChannels().forEach(ch => {
                                                        const element = document.getElementById(`deviceModel${ch}`);
                                                        if (element) {
                                                            element.value = deviceModel[ch] || '';
                                                        }
                                                    });
                                                } else {
                                                    // 舊格式：單一字符串，放入第一個頻道
                                                    const firstChannel = getCurrentChannels()[0];
                                                    if (firstChannel) {
                                                        const element = document.getElementById(`deviceModel${firstChannel}`);
                                                        if (element) {
                                                            element.value = deviceModel || '';
                                                        }
                                                    }
                                                }
                                            }, 500); // 等待500ms讓頻道載入完成
                                        });
                                    } else {
                                        console.warn(`儲存的 MAC ID ${deviceSerial} 不在當前可用列表中`);
                                        // MAC ID 不在列表中，顯示佔位符
                                        displayChannelPlaceholder();
                                    }
                                }, 1000); // 等待1秒讓 MAC ID 選項列表載入完成
                            } else {
                                // 沒有 MAC ID，顯示佔位符
                                displayChannelPlaceholder();
                            }
                            
                            // 如果已有設定，啟用儀表板按鈕
                            if (data.settings.device_name) {
                                document.getElementById('dashboardBtn').disabled = false;
                            }
                        }
                    }
                }
            } catch (error) {
                console.warn('無法載入現有設定:', error);
            }
        }
        
        // 根據 MAC ID 載入設備設定
        async function loadDeviceByMacId(macId) {
            try {
                // 先從設備 API 獲取該設備的詳細資訊
                const devicesResponse = await fetch('/api/dashboard/devices');
                if (!devicesResponse.ok) {
                    throw new Error('無法獲取設備列表');
                }
                
                const devicesData = await devicesResponse.json();
                if (!devicesData.success) {
                    throw new Error(devicesData.message || '獲取設備列表失敗');
                }
                
                // 找到對應的設備
                const targetDevice = devicesData.devices.find(device => device.mac_id === macId);
                if (!targetDevice) {
                    throw new Error(`找不到 MAC ID 為 ${macId} 的設備`);
                }
                
                // 載入該設備的設定資訊
                document.getElementById('deviceName').value = targetDevice.device_name || '';
                document.getElementById('deviceLocation').value = targetDevice.device_location || '';
                document.getElementById('deviceDescription').value = targetDevice.device_description || '';
                
                // 等待 MAC ID 列表載入完成後再設定選中的值
                await loadMacIdList();
                
                // 設定選中的 MAC ID
                const deviceSerialSelect = document.getElementById('deviceSerial');
                deviceSerialSelect.value = macId;
                
                // 載入該 MAC ID 的頻道資訊
                await loadChannelsForMacId(macId);
                
                // 等待頻道載入完成後，填入各頻道的型號
                setTimeout(() => {
                    const deviceModel = targetDevice.device_model || '';
                    if (typeof deviceModel === 'object') {
                        // 新格式：多頻道對象
                        getCurrentChannels().forEach(ch => {
                            const element = document.getElementById(`deviceModel${ch}`);
                            if (element) {
                                element.value = deviceModel[ch] || '';
                            }
                        });
                    } else {
                        // 舊格式：單一字符串，放入第一個頻道
                        const firstChannel = getCurrentChannels()[0];
                        if (firstChannel) {
                            const element = document.getElementById(`deviceModel${firstChannel}`);
                            if (element) {
                                element.value = deviceModel || '';
                            }
                        }
                    }
                }, 500); // 等待500ms讓頻道載入完成
                
                // 如果有廠區，啟用儀表板按鈕
                if (targetDevice.device_name) {
                    document.getElementById('dashboardBtn').disabled = false;
                }
                
                // 顯示成功訊息
                const deviceDisplayName = targetDevice.device_name || `設備 (${macId})`;
                console.log(`成功載入設備設定: ${deviceDisplayName}`);
                
                // 可選：顯示提示訊息
                const messageDiv = document.createElement('div');
                messageDiv.className = 'alert alert-info alert-dismissible fade show mt-3';
                messageDiv.innerHTML = `
                    <strong>已自動載入設備設定</strong><br>
                    正在編輯設備: <strong>${deviceDisplayName}</strong> (MAC ID: ${macId})
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // 在表單前插入提示訊息
                const form = document.getElementById('deviceSettingForm');
                form.parentNode.insertBefore(messageDiv, form);
                
                // 3秒後自動隱藏訊息
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 5000);
                
            } catch (error) {
                console.error('載入指定設備設定失敗:', error);
                alert(`載入設備設定失敗: ${error.message}\n\n將改為載入一般設定。`);
                
                // 載入失敗時，回到一般設定載入模式
                const response = await fetch('/api/device-settings');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('deviceName').value = data.settings.device_name || '';
                        document.getElementById('deviceLocation').value = data.settings.device_location || '';
                        document.getElementById('deviceModel').value = data.settings.device_model || '';
                        document.getElementById('deviceSerial').value = data.settings.device_serial || '';
                        document.getElementById('deviceDescription').value = data.settings.device_description || '';
                        
                        if (data.settings.device_name) {
                            document.getElementById('dashboardBtn').disabled = false;
                        }
                    }
                }
            }
        }

        // 根據MAC ID載入設備設定 (簡化版，用於MAC ID選擇變更時)
        async function loadDeviceSettingsForMacId(macId) {
            if (!macId) {
                console.log('沒有選擇MAC ID，清空設備設定字段');
                // 清空設備設定字段
                document.getElementById('deviceName').value = '';
                document.getElementById('deviceLocation').value = '';
                document.getElementById('deviceDescription').value = '';
                return;
            }

            try {
                console.log(`正在載入MAC ID ${macId} 的設備設定...`);
                
                const response = await fetch(`/api/device-settings?mac_id=${encodeURIComponent(macId)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('設備設定API回應:', data);
                    
                    if (data.success && data.settings) {
                        // 填入設備設定
                        document.getElementById('deviceName').value = data.settings.device_name || '';
                        document.getElementById('deviceLocation').value = data.settings.device_location || '';
                        document.getElementById('deviceDescription').value = data.settings.device_description || '';
                        
                        // 等待一下讓頻道載入完成，然後填入設備型號
                        setTimeout(() => {
                            const deviceModel = data.settings.device_model || '';
                            if (typeof deviceModel === 'object') {
                                // 設備型號是物件（每個頻道不同）
                                CHANNEL_CONFIG.CURRENT_CHANNELS.forEach(ch => {
                                    const element = document.getElementById(`deviceModel${ch}`);
                                    if (element) {
                                        element.value = deviceModel[ch] || '';
                                    }
                                });
                            } else {
                                // 設備型號是字串（所有頻道相同）
                                const firstChannel = CHANNEL_CONFIG.CURRENT_CHANNELS[0];
                                if (firstChannel) {
                                    const element = document.getElementById(`deviceModel${firstChannel}`);
                                    if (element) {
                                        element.value = deviceModel || '';
                                    }
                                }
                            }
                        }, 100);
                        
                        // 載入完成後更新預覽
                        setTimeout(() => {
                            if (typeof updateLivePreview === 'function') {
                                updateLivePreview();
                            }
                        }, 200);
                        
                        console.log(`已載入MAC ID ${macId} 的設備設定`);
                    } else {
                        console.log(`MAC ID ${macId} 沒有保存的設定，使用預設值`);
                        // 沒有保存的設定，清空字段使用預設值
                        document.getElementById('deviceName').value = '';
                        document.getElementById('deviceLocation').value = '';
                        document.getElementById('deviceDescription').value = '';
                    }
                } else {
                    console.warn(`無法載入MAC ID ${macId} 的設定: ${response.status}`);
                }
            } catch (error) {
                console.error(`載入MAC ID ${macId} 設定時發生錯誤:`, error);
            }
        }

        // 獲取MAC ID列表 - 增強版本
        async function loadMacIdList(retryCount = 0) {
            const maxRetries = 2;
            
            try {
                document.getElementById('macIdStatus').textContent = retryCount > 0 ? `載入中... (重試 ${retryCount}/${maxRetries})` : '載入中...';
                
                // 添加時間戳防止快取，並設置較短的超時時間
                const timestamp = new Date().getTime();
                
                // 創建 AbortController 來處理超時（相容性更好）
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15秒超時
                
                // 檢測當前是否在樹梅派上運行（通過檢查端口）
                const isOnRaspberryPi = window.location.port === '5000';
                const apiUrl = isOnRaspberryPi 
                    ? `/api/uart/mac-ids?t=${timestamp}` 
                    : `/api/uart/mac-ids?t=${timestamp}`;
                
                console.log(`正在載入 MAC ID，URL: ${apiUrl}, 運行模式: ${isOnRaspberryPi ? '樹梅派' : 'Dashboard主機'}`);
                
                // 使用相對路徑避免 CORS 問題
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache',
                        'Accept': 'application/json'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId); // 清除超時定時器
                
                console.log('MAC ID API 響應狀態:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('MAC ID API 響應數據:', data);
                    
                    // 更新調試面板
                    updateDebugInfo('MAC ID API', data);
                    
                    if (data.success && data.mac_ids && data.mac_ids.length > 0) {
                        updateMacIdOptions(data.mac_ids);
                        
                        const dataSource = data.data_source || '未知來源';
                        const statusText = `已載入 ${data.mac_ids.length} 個 MAC ID (來源: ${dataSource}, 最新: ${new Date().toLocaleTimeString()})`;
                        
                        document.getElementById('macIdStatus').textContent = statusText;
                        document.getElementById('macIdStatus').className = 'text-success ms-2';
                    } else {
                        const message = data.message || 'MAC ID 列表為空';
                        document.getElementById('macIdStatus').textContent = message;
                        document.getElementById('macIdStatus').className = 'text-warning ms-2';
                        console.warn('MAC ID 數據為空或無效:', data);
                        
                        // 更新調試面板中的 MAC ID 狀態
                        updateDebugMacIds([]);
                        
                        // 如果數據來源是歷史文件但沒有數據，提供更多資訊
                        if (data.data_source === '歷史文件') {
                            document.getElementById('macIdStatus').textContent = '歷史文件中沒有 MAC ID 數據，請確認 UART 是否正確接收過數據';
                        }
                    }
                } else {
                    const errorText = `HTTP 錯誤：${response.status} - ${response.statusText}`;
                    document.getElementById('macIdStatus').textContent = errorText;
                    document.getElementById('macIdStatus').className = 'text-danger ms-2';
                    console.error('HTTP 錯誤:', response.status, response.statusText);
                    
                    // 更新調試面板
                    updateDebugInfo('MAC ID API 錯誤', { error: errorText });
                }
            } catch (error) {
                console.error('載入 MAC ID 列表失敗:', error);
                
                let errorMessage = '載入失敗';
                let shouldRetry = false;
                
                if (error.name === 'AbortError') {
                    errorMessage = '請求超時，請檢查伺服器狀態';
                    shouldRetry = true;
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = '無法連接到伺服器，請確認服務是否運行';
                    shouldRetry = true;
                } else {
                    errorMessage = `載入失敗: ${error.message}`;
                }
                
                // 如果可以重試且未達到最大重試次數，則進行重試
                if (shouldRetry && retryCount < maxRetries) {
                    console.log(`準備重試載入 MAC ID (${retryCount + 1}/${maxRetries})`);
                    document.getElementById('macIdStatus').textContent = `連接失敗，將在3秒後重試... (${retryCount + 1}/${maxRetries})`;
                    document.getElementById('macIdStatus').className = 'text-warning ms-2';
                    
                    // 3秒後重試
                    setTimeout(() => {
                        loadMacIdList(retryCount + 1);
                    }, 3000);
                    return;
                }
                
                // 最終失敗或不可重試的錯誤
                const finalMessage = retryCount >= maxRetries 
                    ? `${errorMessage} (已重試 ${maxRetries} 次)` 
                    : errorMessage;
                    
                document.getElementById('macIdStatus').textContent = finalMessage;
                document.getElementById('macIdStatus').className = 'text-danger ms-2';
                
                // 更新調試面板
                updateDebugInfo('MAC ID API 異常', { 
                    error: error.message, 
                    errorType: error.name,
                    retryCount: retryCount,
                    maxRetries: maxRetries
                });
                
                // 如果是最終失敗，拋出錯誤供上層處理
                if (retryCount >= maxRetries) {
                    throw error;
                }
            }
        }

        // 更新MAC ID選項
        function updateMacIdOptions(macIds) {
            console.log('更新 MAC ID 選項，接收到的 MAC IDs:', macIds);
            
            const select = document.getElementById('deviceSerial');
            const currentValue = select.value;
            
            // 清除現有選項（保留預設選項）
            select.innerHTML = '<option value="">請選擇 MAC ID</option>';
            
            // 添加去重複的MAC ID選項
            const uniqueMacIds = [...new Set(macIds)];
            console.log('去重複後的 MAC IDs:', uniqueMacIds);
            
            // 更新調試面板中的 MAC ID 信息
            updateDebugMacIds(uniqueMacIds);
            
            if (uniqueMacIds.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '暫無可用的 MAC ID';
                option.disabled = true;
                select.appendChild(option);
                console.warn('沒有可用的 MAC ID');
            } else {
                uniqueMacIds.forEach((macId, index) => {
                    if (macId && macId.trim() && macId !== 'N/A') {
                        const option = document.createElement('option');
                        option.value = macId;
                        option.textContent = macId;
                        select.appendChild(option);
                        console.log(`添加 MAC ID ${index + 1}:`, macId);
                    }
                });
            }
            
            // 如果原本有選中的值且仍存在，重新選中
            if (currentValue && uniqueMacIds.includes(currentValue)) {
                select.value = currentValue;
                console.log('恢復之前選中的 MAC ID:', currentValue);
                // 重新載入該 MAC ID 的頻道資訊
                loadChannelsForMacId(currentValue);
            }
            
            // 添加 MAC ID 選擇變更事件監聽器（避免重複綁定）
            select.onchange = function() {
                const selectedMacId = this.value;
                console.log('選擇了新的 MAC ID:', selectedMacId);
                
                // 立即更新預覽中的設備序號
                document.getElementById('previewSerialDetail').textContent = selectedMacId || '未設定';
                
                // 載入頻道資訊
                loadChannelsForMacId(selectedMacId);
                
                // 載入該MAC ID的設備設定
                if (selectedMacId) {
                    loadDeviceSettingsForMacId(selectedMacId);
                } else {
                    // 如果未選擇，清空預覽
                    document.getElementById('previewSerialDetail').textContent = '未設定';
                }
            };
        }

        // 手動刷新MAC ID列表
        function refreshMacIdList() {
            console.log('手動刷新 MAC ID 列表');
            loadMacIdList();
        }
        
        // 自動定期刷新MAC ID列表 - 改進版本
        function startAutoRefreshMacIds() {
            let refreshInterval = 30000; // 30秒
            let failureCount = 0;
            
            const autoRefresh = async () => {
                try {
                    console.log('自動刷新 MAC ID 列表');
                    
                    // 顯示自動刷新狀態
                    const statusElement = document.getElementById('macIdStatus');
                    const currentText = statusElement.textContent;
                    if (!currentText.includes('載入中') && !currentText.includes('測試中')) {
                        statusElement.textContent = '自動更新中...';
                        statusElement.className = 'text-info ms-2';
                    }
                    
                    await loadMacIdList();
                    failureCount = 0; // 成功後重置失敗計數
                    refreshInterval = 30000; // 重置為30秒間隔
                    
                } catch (error) {
                    failureCount++;
                    console.warn(`自動刷新失敗 (第${failureCount}次):`, error);
                    
                    // 如果多次失敗，增加刷新間隔
                    if (failureCount > 3) {
                        refreshInterval = Math.min(120000, refreshInterval * 1.5); // 最大2分鐘
                        console.warn(`連續失敗${failureCount}次，調整刷新間隔為 ${refreshInterval/1000} 秒`);
                    }
                }
                
                // 設定下次自動刷新
                setTimeout(autoRefresh, refreshInterval);
            };
            
            // 延遲10秒後開始第一次自動刷新
            setTimeout(autoRefresh, 10000);
            
            console.log(`MAC ID 自動刷新已啟動，間隔 ${refreshInterval/1000} 秒`);
        }
        
        // 測試 API 連接
        async function testApiConnection() {
            try {
                console.log('測試 API 連接');
                const statusElement = document.getElementById('macIdStatus');
                statusElement.textContent = '測試 API 連接中...';
                statusElement.className = 'text-info ms-2';
                
                // 測試基本的 API 端點
                const tests = [
                    { name: 'UART 狀態', url: '/api/uart/status' },
                    { name: 'MAC ID 列表', url: '/api/uart/mac-ids' },
                    { name: '設備設定', url: '/api/device-settings' }
                ];
                
                let results = [];
                
                for (const test of tests) {
                    try {
                        // 創建 AbortController 來處理超時
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000); // 5秒超時
                        
                        const response = await fetch(test.url, {
                            method: 'GET',
                            cache: 'no-cache',
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        results.push({
                            name: test.name,
                            status: response.status,
                            ok: response.ok,
                            message: response.ok ? '成功' : `HTTP ${response.status}`
                        });
                        
                        console.log(`${test.name} API 測試: ${response.status}`);
                    } catch (error) {
                        results.push({
                            name: test.name,
                            status: 'ERROR',
                            ok: false,
                            message: error.name === 'AbortError' ? '超時' : error.message
                        });
                        
                        console.error(`${test.name} API 測試失敗:`, error);
                    }
                }
                
                // 顯示測試結果
                const successCount = results.filter(r => r.ok).length;
                const totalTests = results.length;
                
                let statusMessage = `API 測試完成: ${successCount}/${totalTests} 成功`;
                let statusClass = successCount === totalTests ? 'text-success ms-2' : 
                                 successCount > 0 ? 'text-warning ms-2' : 'text-danger ms-2';
                
                statusElement.textContent = statusMessage;
                statusElement.className = statusClass;
                
                // 更新調試面板
                updateDebugInfo('API 連接測試', { results, summary: statusMessage });
                
                // 顯示詳細結果
                const detailsText = results.map(r => 
                    `${r.name}: ${r.message}`
                ).join('\n');
                
                if (successCount < totalTests) {
                    alert(`API 連接測試結果:\n\n${detailsText}\n\n建議檢查:\n1. Flask 應用程式是否在 5001 端口運行\n2. 防火牆是否允許連接\n3. 網路連接是否正常`);
                } else {
                    alert(`API 連接測試全部成功!\n\n${detailsText}`);
                    // 如果全部成功，自動重新載入 MAC ID
                    await loadMacIdList();
                }
                
            } catch (error) {
                console.error('API 連接測試失敗:', error);
                const statusElement = document.getElementById('macIdStatus');
                statusElement.textContent = `API 測試失敗: ${error.message}`;
                statusElement.className = 'text-danger ms-2';
                
                alert(`API 連接測試時發生錯誤:\n${error.message}`);
            }
        }
        
        // 更新調試面板的 API 信息
        function updateDebugInfo(apiName, responseData) {
            try {
                const statusElement = document.getElementById('debugApiStatus');
                const responseElement = document.getElementById('debugApiResponse');
                
                if (statusElement) {
                    statusElement.innerHTML = `
                        <strong>最近 API 呼叫:</strong> ${apiName}<br>
                        <strong>時間:</strong> ${new Date().toLocaleString()}<br>
                        <strong>狀態:</strong> <span class="text-success">成功</span>
                    `;
                }
                
                if (responseElement) {
                    responseElement.textContent = JSON.stringify(responseData, null, 2);
                }
            } catch (error) {
                console.error('更新調試信息失敗:', error);
            }
        }
        
        // 更新調試面板的 MAC ID 信息
        function updateDebugMacIds(macIds) {
            try {
                const debugElement = document.getElementById('debugMacIds');
                if (debugElement) {
                    if (macIds.length === 0) {
                        debugElement.innerHTML = `
                            <div class="text-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>目前沒有可用的 MAC ID
                            </div>
                            <small class="text-muted">
                                可能的原因：<br>
                                1. UART 服務未啟動<br>
                                2. 設備未連接或未發送數據<br>
                                3. 數據格式不正確
                            </small>
                        `;
                    } else {
                        debugElement.innerHTML = `
                            <div class="text-success">
                                <i class="fas fa-check-circle me-2"></i>發現 ${macIds.length} 個 MAC ID
                            </div>
                            <div class="mt-2">
                                ${macIds.map(id => `<span class="badge bg-secondary me-1">${id}</span>`).join('')}
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('更新 MAC ID 調試信息失敗:', error);
            }
        }

        // 預覽設定
        function previewSettings() {
            const deviceName = document.getElementById('deviceName').value || '未設定廠區';
            const deviceLocation = document.getElementById('deviceLocation').value;
            
            // 取得當前實際可用頻道的型號
            const deviceModels = {};
            getCurrentChannels().forEach(ch => {
                const element = document.getElementById(`deviceModel${ch}`);
                if (element) {
                    deviceModels[ch] = element.value || '未設定';
                }
            });
            
            const deviceSerialSelect = document.getElementById('deviceSerial');
            const deviceSerial = deviceSerialSelect.value || '未選擇';
            const deviceDescription = document.getElementById('deviceDescription').value || '未設定';

            // 更新預覽內容
            document.getElementById('previewDeviceName').textContent = deviceName;
            document.getElementById('previewLocation').textContent = deviceLocation ? ` | ${deviceLocation}` : '';
            document.getElementById('previewNameDetail').textContent = deviceName;
            document.getElementById('previewLocationDetail').textContent = deviceLocation || '未設定';
            
            // 顯示第一個有內容的頻道型號作為主要顯示
            let mainModel = '未設定';
            for (const ch of getCurrentChannels()) {
                if (deviceModels[ch] && deviceModels[ch] !== '未設定') {
                    mainModel = `頻道 ${ch}: ${deviceModels[ch]}`;
                    break;
                }
            }
            document.getElementById('previewModelDetail').textContent = mainModel;
            document.getElementById('previewSerialDetail').textContent = deviceSerial;
            document.getElementById('previewDescriptionDetail').textContent = deviceDescription;
            
            // 顯示預覽區域
            document.getElementById('previewSection').style.display = 'block';
            
            // 滾動到預覽區域
            document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
        }

        // 重置表單
        function resetForm() {
            if (confirm('確定要重置所有設定嗎？')) {
                document.getElementById('deviceSettingForm').reset();
                document.getElementById('previewSection').style.display = 'none';
                document.getElementById('dashboardBtn').disabled = true;
                // 重置頻道顯示
                displayChannelPlaceholder();
            }
        }

        // 載入預設設定
        function loadDefaultSettings() {
            document.getElementById('deviceName').value = '預設設備';
            document.getElementById('deviceLocation').value = '生產線A區';
            
            // 為預設設定選擇第一個可用的MAC ID（如果有的話）
            const selectElement = document.getElementById('deviceSerial');
            if (selectElement.options.length > 1) {
                selectElement.selectedIndex = 1; // 選擇第一個MAC ID（跳過"請選擇"選項）
                const selectedMacId = selectElement.value;
                
                // 載入該 MAC ID 的頻道資訊，然後填入預設型號
                loadChannelsForMacId(selectedMacId).then(() => {
                    setTimeout(() => {
                        getCurrentChannels().forEach(ch => {
                            const element = document.getElementById(`deviceModel${ch}`);
                            if (element) {
                                element.value = `Standard Model CH${ch}`;
                            }
                        });
                    }, 500);
                });
            } else {
                // 如果沒有MAC ID，顯示提示
                alert('尚未載入MAC ID列表，請先啟動UART或點擊重新整理按鈕');
                return;
            }
            
            document.getElementById('deviceDescription').value = '這是系統預設的設備設定';
            
            alert('已載入預設設定，請檢查並儲存');
        }

        // 匯出設定
        function exportSettings() {
            // 收集當前實際可用頻道的型號
            const deviceModels = {};
            getCurrentChannels().forEach(ch => {
                const element = document.getElementById(`deviceModel${ch}`);
                if (element) {
                    deviceModels[ch] = element.value.trim();
                }
            });
            
            const settings = {
                device_name: document.getElementById('deviceName').value,
                device_location: document.getElementById('deviceLocation').value,
                device_model: deviceModels,
                device_serial: document.getElementById('deviceSerial').value,
                device_description: document.getElementById('deviceDescription').value,
                channel_info: {
                    current_channels: getCurrentChannels(),
                    total_channels: getCurrentChannels().length
                },
                export_time: new Date().toISOString()
            };

            const dataStr = JSON.stringify(settings, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `device_settings_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            link.click();
        }

        // 前往儀表板
        function goToDashboard() {
            window.location.href = '/dashboard';
        }

        // 表單提交處理
        document.getElementById('deviceSettingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const deviceName = document.getElementById('deviceName').value.trim();
            if (!deviceName) {
                alert('請輸入廠區！');
                return;
            }

            // 檢查是否需要重定向到 dashboard
            const urlParams = new URLSearchParams(window.location.search);
            const shouldRedirectToDashboard = urlParams.get('redirect') === 'true';
            
            // 收集當前實際可用頻道的型號
            const deviceModels = {};
            getCurrentChannels().forEach(ch => {
                const element = document.getElementById(`deviceModel${ch}`);
                if (element) {
                    deviceModels[ch] = element.value.trim();
                }
            });
            
            const settings = {
                device_name: deviceName,
                device_location: document.getElementById('deviceLocation').value.trim(),
                device_model: deviceModels,
                device_serial: document.getElementById('deviceSerial').value.trim(),
                device_description: document.getElementById('deviceDescription').value.trim(),
                redirect_to_dashboard: shouldRedirectToDashboard
            };

            try {
                const response = await fetch('/api/device-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('設定儲存成功！');
                    document.getElementById('dashboardBtn').disabled = false;
                    
                    // 檢查後端是否提供了重定向 URL
                    if (data.redirect_url) {
                        console.log('後端提供重定向 URL:', data.redirect_url);
                        window.location.href = data.redirect_url;
                    } else {
                        // 自動跳轉到 dashboard 頁面
                        setTimeout(() => {
                            window.location.href = '/dashboard';
                        }, 1000); // 1秒後跳轉，讓用戶看到成功訊息
                    }
                    
                } else {
                    alert('儲存失敗：' + (data.message || '未知錯誤'));
                    console.error('設定儲存失敗:', data);
                }
            } catch (error) {
                console.error('儲存設定時發生錯誤:', error);
                
                let errorMessage = '儲存設定時發生錯誤，請稍後再試。';
                
                // 提供更詳細的錯誤信息
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = '無法連接到伺服器，請檢查：\n1. Flask 應用程式是否正在運行\n2. 網路連接是否正常\n3. 伺服器端口是否正確 (5000)';
                } else if (error.name === 'SyntaxError') {
                    errorMessage = '伺服器響應格式錯誤，請檢查伺服器狀態';
                } else {
                    errorMessage += '\n錯誤詳情：' + error.message;
                }
                
                alert(errorMessage);
            }
        });

        // 簡單的 API 測試函數
        async function debugMacIdApi() {
            try {
                console.log('=== 開始調試 MAC ID API ===');
                
                // 顯示當前瀏覽器信息
                console.log('User Agent:', navigator.userAgent);
                console.log('當前 URL:', window.location.href);
                
                const timestamp = new Date().getTime();
                const url = `/api/uart/mac-ids?t=${timestamp}`;
                console.log('請求 URL:', url);
                
                // 使用相對路徑而不是絕對路徑
                const response = await fetch(url, {
                    method: 'GET',
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                console.log('響應狀態:', response.status);
                console.log('響應頭:', [...response.headers.entries()]);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('響應數據:', data);
                    alert(`調試成功！\n狀態: ${response.status}\nMAC IDs: ${data.mac_ids?.join(', ') || '無'}\n數據來源: ${data.data_source || '未知'}`);
                } else {
                    console.error('HTTP 錯誤:', response.status, response.statusText);
                    alert(`HTTP 錯誤: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('調試錯誤:', error);
                alert(`調試錯誤: ${error.message}`);
            }
        }
        
        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
            
            // 先載入 MAC ID 列表，然後載入現有設定
            loadMacIdList().then(() => {
                loadExistingSettings();
            });
            
            // 啟動自動刷新MAC ID功能
            startAutoRefreshMacIds();
            
            // 監聽輸入變化以即時啟用/停用按鈕
            document.getElementById('deviceName').addEventListener('input', function() {
                const hasDeviceName = this.value.trim().length > 0;
                document.getElementById('dashboardBtn').disabled = !hasDeviceName;
                
                // 即時更新預覽
                updateLivePreview();
            });
            
            // 監聽其他欄位的變化以即時更新預覽
            document.getElementById('deviceLocation').addEventListener('input', updateLivePreview);
            document.getElementById('deviceDescription').addEventListener('input', updateLivePreview);
            
            // 即時更新預覽的函數
            function updateLivePreview() {
                const deviceName = document.getElementById('deviceName').value.trim() || '未設定';
                const deviceLocation = document.getElementById('deviceLocation').value.trim();
                const deviceSerial = document.getElementById('deviceSerial').value.trim() || '未設定';
                const deviceDescription = document.getElementById('deviceDescription').value.trim() || '未設定';
                
                // 更新預覽內容
                document.getElementById('previewDeviceName').textContent = deviceName;
                document.getElementById('previewLocation').textContent = deviceLocation ? ` | ${deviceLocation}` : '';
                document.getElementById('previewNameDetail').textContent = deviceName;
                document.getElementById('previewLocationDetail').textContent = deviceLocation || '未設定';
                document.getElementById('previewSerialDetail').textContent = deviceSerial;
                document.getElementById('previewDescriptionDetail').textContent = deviceDescription;
                
                // 如果有內容就顯示預覽區域
                if (deviceName !== '未設定' || deviceSerial !== '未設定') {
                    document.getElementById('previewSection').style.display = 'block';
                }
            }
        });
    </script>
    
    <script>
        // 側邊欄收合功能
        document.addEventListener('DOMContentLoaded', function() {
            var sidebar = document.getElementById('sidebar');
            var collapseBtn = document.getElementById('sidebarCollapseBtn');
            var isCollapsed = false;
            
            function toggleSidebarCollapse() {
                isCollapsed = !isCollapsed;
                sidebar.classList.toggle('collapsed', isCollapsed);
                document.body.style.paddingLeft = isCollapsed ? '60px' : '220px';
            }
            
            if (collapseBtn) {
                collapseBtn.addEventListener('click', toggleSidebarCollapse);
            }
            
            // 小螢幕收合
            function toggleSidebarMobile() {
                sidebar.classList.toggle('show');
                if (sidebar.classList.contains('show')) {
                    document.body.style.paddingLeft = isCollapsed ? '60px' : '220px';
                } else {
                    document.body.style.paddingLeft = '0';
                }
            }
            
            // === 樹梅派配置管理函數 ===
            // 載入樹梅派配置
            async function loadRaspberryPiConfig() {
                try {
                    const response = await fetch('/api/dashboard/config', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.config) {
                            document.getElementById('raspberryPiHost').value = data.config.raspberry_pi_host || '192.168.1.100';
                            document.getElementById('raspberryPiPort').value = data.config.raspberry_pi_port || '5000';
                            
                            const status = document.getElementById('raspberryPiStatus');
                            status.innerHTML = `<i class="fas fa-check-circle text-success"></i> 已載入配置: ${data.config.raspberry_pi_host}:${data.config.raspberry_pi_port}`;
                        }
                    }
                } catch (error) {
                    console.warn('載入樹梅派配置失敗:', error);
                }
            }
            
            // 保存樹梅派配置
            async function saveRaspberryPiConfig() {
                try {
                    const host = document.getElementById('raspberryPiHost').value.trim();
                    const port = parseInt(document.getElementById('raspberryPiPort').value) || 5000;
                    
                    if (!host) {
                        alert('請輸入樹梅派 IP 地址');
                        return;
                    }
                    
                    const status = document.getElementById('raspberryPiStatus');
                    status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存配置中...';
                    
                    const response = await fetch('/api/dashboard/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            raspberry_pi_host: host,
                            raspberry_pi_port: port
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        status.innerHTML = `<i class="fas fa-check-circle text-success"></i> 配置已保存: ${host}:${port}`;
                        
                        // 立即測試連接
                        setTimeout(() => {
                            testRaspberryPiConnection();
                        }, 1000);
                        
                    } else {
                        status.innerHTML = `<i class="fas fa-exclamation-triangle text-warning"></i> 保存失敗: ${data.message}`;
                    }
                    
                } catch (error) {
                    console.error('保存樹梅派配置失敗:', error);
                    const status = document.getElementById('raspberryPiStatus');
                    status.innerHTML = `<i class="fas fa-times-circle text-danger"></i> 保存失敗: ${error.message}`;
                }
            }
            
            // 測試樹梅派連接
            async function testRaspberryPiConnection() {
                try {
                    const status = document.getElementById('raspberryPiStatus');
                    status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 測試連接中...';
                    
                    // 嘗試訪問樹梅派的 API
                    const host = document.getElementById('raspberryPiHost').value.trim();
                    const port = parseInt(document.getElementById('raspberryPiPort').value) || 5000;
                    
                    const testResponse = await fetch('/api/uart/mac-ids', {
                        method: 'GET',
                        headers: {
                            'Cache-Control': 'no-cache'
                        }
                    });
                    
                    if (testResponse.ok) {
                        const testData = await testResponse.json();
                        if (testData.success) {
                            status.innerHTML = `<i class="fas fa-check-circle text-success"></i> 連接成功！找到 ${testData.mac_ids ? testData.mac_ids.length : 0} 個 MAC ID`;
                            
                            // 自動重新載入 MAC ID 列表
                            loadMacIdList();
                        } else {
                            status.innerHTML = `<i class="fas fa-exclamation-triangle text-warning"></i> 連接成功但無數據: ${testData.message}`;
                        }
                    } else {
                        status.innerHTML = `<i class="fas fa-times-circle text-danger"></i> 連接失敗: HTTP ${testResponse.status}`;
                    }
                    
                } catch (error) {
                    console.error('測試樹梅派連接失敗:', error);
                    const status = document.getElementById('raspberryPiStatus');
                    
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        status.innerHTML = `<i class="fas fa-times-circle text-danger"></i> 無法連接到 ${document.getElementById('raspberryPiHost').value}`;
                    } else {
                        status.innerHTML = `<i class="fas fa-times-circle text-danger"></i> 測試失敗: ${error.message}`;
                    }
                }
            }
            
            // 支援點擊主畫面自動收合（小螢幕）
            document.addEventListener('click', function(e) {
                if(window.innerWidth < 992 && sidebar.classList.contains('show')){
                    if(!sidebar.contains(e.target) && e.target !== collapseBtn){
                        sidebar.classList.remove('show');
                        document.body.style.paddingLeft = '0';
                    }
                }
            });
            
            // 頁面載入時自動載入樹梅派配置
            loadRaspberryPiConfig();
        });
    </script>
</body>
</html>
