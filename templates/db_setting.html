<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB 設定 - 系統配置</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .setting-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 30px;
        }
        .card {
            transition: transform 0.2s;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-1px);
        }
        .preview-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .device-info-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background-color: #28a745;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-light">
    <div class="setting-header py-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col">
                    <h1 class="mb-0"><i class="fas fa-cogs me-2"></i>DB 設定</h1>
                    <p class="mb-0 opacity-75">設定設備資訊與系統參數</p>
                </div>
                <div class="col-auto">
                    <span id="current-time" class="badge bg-light text-dark fs-6"></span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 重定向提示 -->
        {% if redirect_to_dashboard %}
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>需要完成設備設定</strong> - 您必須先設定設備資訊才能使用系統監控儀表板。
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- 設備資訊設定 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-microchip me-2"></i>設備資訊設定</h5>
                    </div>
                    <div class="card-body">
                        <form id="deviceSettingForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="deviceName" class="form-label">
                                            <i class="fas fa-tag me-1"></i>設備名稱 <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="deviceName" 
                                               placeholder="請輸入設備名稱（例如：生產線A-1）" 
                                               maxlength="50" required>
                                        <div class="form-text">設備名稱將顯示在儀表板標題中，最多50個字元</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="deviceLocation" class="form-label">
                                            <i class="fas fa-map-marker-alt me-1"></i>設備位置
                                        </label>
                                        <input type="text" class="form-control" id="deviceLocation" 
                                               placeholder="請輸入設備位置（例如：廠房B-2樓）"
                                               maxlength="100">
                                        <div class="form-text">選填，用於設備識別和管理</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-cube me-1"></i>設備型號
                                        </label>
                                        <div class="form-text mb-2">
                                            <span id="channelInfo">請先選擇 MAC ID 以載入頻道資訊</span>
                                        </div>
                                        <div class="row g-2" id="deviceModelContainer">
                                            <!-- 動態生成的頻道輸入欄位將在這裡顯示 -->
                                            <div class="col-12 text-center text-muted py-3">
                                                <i class="fas fa-info-circle me-2"></i>請先選擇設備序號 (MAC ID) 以載入頻道配置
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="deviceSerial" class="form-label">
                                            <i class="fas fa-barcode me-1"></i>設備序號 (MAC ID)
                                        </label>
                                        <div class="input-group">
                                            <select class="form-select" id="deviceSerial">
                                                <option value="">請選擇 MAC ID</option>
                                            </select>
                                            <button class="btn btn-outline-secondary" type="button" onclick="refreshMacIdList()">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            從 UART 接收到的 MAC ID 中選擇
                                            <span id="macIdStatus" class="text-muted ms-2"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="deviceDescription" class="form-label">
                                    <i class="fas fa-align-left me-1"></i>設備描述
                                </label>
                                <textarea class="form-control" id="deviceDescription" rows="3" 
                                          placeholder="請輸入設備的詳細描述或備註"
                                          maxlength="500"></textarea>
                                <div class="form-text">選填，最多500個字元</div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button type="button" class="btn btn-outline-secondary me-2" onclick="resetForm()">
                                        <i class="fas fa-undo me-1"></i>重置
                                    </button>
                                    <button type="button" class="btn btn-success me-2" onclick="previewSettings()">
                                        <i class="fas fa-eye me-1"></i>預覽
                                    </button>
                                </div>
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-1"></i>儲存設定
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 預覽區域 -->
        <div class="row mb-4" id="previewSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-eye me-2"></i>設定預覽</h5>
                    </div>
                    <div class="card-body">
                        <div class="preview-section">
                            <h6 class="mb-3">儀表板標題預覽：</h6>
                            <div class="device-info-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h4 class="mb-0">
                                            <i class="fas fa-tachometer-alt me-2"></i>
                                            <span id="previewDeviceName">未設定設備名稱</span> - Flask Dashboard
                                        </h4>
                                        <p class="mb-0 opacity-75">
                                            <span class="status-indicator"></span>
                                            系統監控與應用程式狀態
                                            <span id="previewLocation"></span>
                                        </p>
                                    </div>
                                    <div class="text-end">
                                        <small>即時狀態</small>
                                        <div class="fw-bold" id="previewTime">--</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <h6>設備詳細資訊：</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <strong>設備名稱：</strong><br>
                                        <span id="previewNameDetail">未設定</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>設備位置：</strong><br>
                                        <span id="previewLocationDetail">未設定</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>設備型號：</strong><br>
                                        <span id="previewModelDetail">未設定</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>設備序號：</strong><br>
                                        <span id="previewSerialDetail">未設定</span>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <strong>設備描述：</strong><br>
                                        <span id="previewDescriptionDetail">未設定</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 快速導航 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-compass me-2"></i>快速導航</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button class="btn btn-outline-primary w-100 mb-2" onclick="goToDashboard()" disabled id="dashboardBtn">
                                    <i class="fas fa-tachometer-alt me-2"></i>前往儀表板
                                </button>
                                <small class="text-muted">需先儲存設定才能前往</small>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-success w-100 mb-2" onclick="refreshMacIdList()">
                                    <i class="fas fa-sync-alt me-2"></i>更新 MAC ID
                                </button>
                                <small class="text-muted">重新載入UART接收的MAC ID</small>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-info w-100 mb-2" onclick="loadDefaultSettings()">
                                    <i class="fas fa-magic me-2"></i>載入預設設定
                                </button>
                                <small class="text-muted">使用系統預設的設備設定</small>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-warning w-100 mb-2" onclick="exportSettings()">
                                    <i class="fas fa-download me-2"></i>匯出設定
                                </button>
                                <small class="text-muted">將設定匯出為檔案備份</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 頻道配置 - 只顯示頻道 0-6 供用戶設定設備型號（頻道 7 為電池電壓，系統自動處理）
        let CHANNEL_CONFIG = {
            MIN_CHANNEL: 0,    // 最小頻道號
            MAX_CHANNEL: 6,    // 最大頻道號（用戶可設定的）
            CURRENT_CHANNELS: [] // 當前實際可用的頻道（只包含 0-6）
        };
        
        // 獲取當前實際可用的頻道列表
        function getCurrentChannels() {
            return CHANNEL_CONFIG.CURRENT_CHANNELS.length > 0 ? 
                   CHANNEL_CONFIG.CURRENT_CHANNELS : 
                   getDefaultChannels();
        }
        
        // 獲取預設頻道列表（0-6）
        function getDefaultChannels() {
            const channels = [];
            for (let i = CHANNEL_CONFIG.MIN_CHANNEL; i <= CHANNEL_CONFIG.MAX_CHANNEL; i++) {
                channels.push(i.toString());
            }
            return channels;
        }
        
        // 根據 MAC ID 載入頻道資訊
        async function loadChannelsForMacId(macId) {
            if (!macId) {
                // 如果沒有選擇 MAC ID，顯示提示資訊
                displayChannelPlaceholder();
                return;
            }
            
            try {
                document.getElementById('channelInfo').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>載入頻道資訊中...';
                
                const response = await fetch(`/api/uart/mac-channels/${macId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.channels && data.channels.length > 0) {
                        // 只保留頻道 0-6（過濾掉頻道 7 電池電壓）
                        const userConfigChannels = data.channels.filter(ch => ch >= 0 && ch <= 6);
                        
                        // 更新頻道配置
                        CHANNEL_CONFIG.CURRENT_CHANNELS = userConfigChannels.map(ch => ch.toString());
                        
                        // 動態生成頻道輸入欄位（只顯示 0-6）
                        generateChannelInputs(userConfigChannels);
                        
                        // 更新提示資訊
                        const hasChannel7 = data.channels.includes(7);
                        const statusMsg = hasChannel7 ? 
                            `已載入 ${userConfigChannels.length} 個設備型號頻道: ${userConfigChannels.join(', ')} (頻道7為電池電壓，無需設定型號)` :
                            `已載入 ${userConfigChannels.length} 個頻道: ${userConfigChannels.join(', ')}`;
                        
                        document.getElementById('channelInfo').innerHTML = 
                            `<i class="fas fa-check-circle text-success me-2"></i>${statusMsg}`;
                    } else {
                        // 沒有找到頻道資料，使用預設配置
                        console.warn(`MAC ID ${macId} 沒有找到頻道資料，使用預設配置`);
                        CHANNEL_CONFIG.CURRENT_CHANNELS = getDefaultChannels();
                        generateChannelInputs(getDefaultChannels().map(ch => parseInt(ch)));
                        document.getElementById('channelInfo').innerHTML = 
                            `<i class="fas fa-exclamation-triangle text-warning me-2"></i>未找到該 MAC ID 的頻道資料，使用預設配置 (頻道 0-6)`;
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('載入頻道資訊失敗:', error);
                // 載入失敗時使用預設配置
                CHANNEL_CONFIG.CURRENT_CHANNELS = getDefaultChannels();
                generateChannelInputs(getDefaultChannels().map(ch => parseInt(ch)));
                document.getElementById('channelInfo').innerHTML = 
                    `<i class="fas fa-exclamation-triangle text-danger me-2"></i>載入頻道資訊失敗，使用預設配置: ${error.message}`;
            }
        }
        
        // 動態生成頻道輸入欄位
        function generateChannelInputs(channels) {
            const container = document.getElementById('deviceModelContainer');
            container.innerHTML = ''; // 清空容器
            
            // 根據頻道數量決定每行顯示的欄位數
            let colClass = 'col-4'; // 預設每行3個
            if (channels.length <= 2) {
                colClass = 'col-6'; // 1-2個頻道時每行2個
            } else if (channels.length <= 4) {
                colClass = 'col-3'; // 3-4個頻道時每行4個
            } else if (channels.length <= 6) {
                colClass = 'col-4'; // 5-6個頻道時每行3個
            } else {
                colClass = 'col-3'; // 7個以上頻道時每行4個
            }
            
            channels.forEach(channel => {
                const channelDiv = document.createElement('div');
                channelDiv.className = colClass;
                channelDiv.innerHTML = `
                    <label for="deviceModel${channel}" class="form-label small">頻道 ${channel}</label>
                    <input type="text" class="form-control" id="deviceModel${channel}" 
                        placeholder="頻道${channel}型號" maxlength="50">
                `;
                container.appendChild(channelDiv);
            });
        }
        
        // 顯示頻道佔位符
        function displayChannelPlaceholder() {
            const container = document.getElementById('deviceModelContainer');
            container.innerHTML = `
                <div class="col-12 text-center text-muted py-3">
                    <i class="fas fa-info-circle me-2"></i>請先選擇設備序號 (MAC ID) 以載入頻道配置
                </div>
            `;
            document.getElementById('channelInfo').innerHTML = '請先選擇 MAC ID 以載入頻道資訊';
            CHANNEL_CONFIG.CURRENT_CHANNELS = [];
        }
        // 更新時間顯示
        function updateTime() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            document.getElementById('current-time').textContent = now.toLocaleString('zh-TW', options);
            document.getElementById('previewTime').textContent = now.toLocaleString('zh-TW', options);
        }

        // 載入現有設定
        async function loadExistingSettings() {
            try {
                // 檢查 URL 是否包含 mac_id 參數
                const urlParams = new URLSearchParams(window.location.search);
                const targetMacId = urlParams.get('mac_id');
                
                if (targetMacId) {
                    // 如果有指定 MAC ID，先載入所有設備資訊
                    console.log(`正在載入指定設備的設定: ${targetMacId}`);
                    await loadDeviceByMacId(targetMacId);
                } else {
                    // 沒有指定 MAC ID，載入一般設定
                    const response = await fetch('/api/device-settings');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            document.getElementById('deviceName').value = data.settings.device_name || '';
                            document.getElementById('deviceLocation').value = data.settings.device_location || '';
                            // 先載入 MAC ID，然後載入對應的頻道和型號
                            const deviceSerial = data.settings.device_serial || '';
                            document.getElementById('deviceSerial').value = deviceSerial;
                            
                            // 如果有 MAC ID，載入其頻道資訊，然後填入型號
                            if (deviceSerial) {
                                await loadChannelsForMacId(deviceSerial);
                                // 等待頻道載入完成後，填入型號
                                setTimeout(() => {
                                    const deviceModel = data.settings.device_model || '';
                                    if (typeof deviceModel === 'object') {
                                        // 新格式：多頻道對象
                                        getCurrentChannels().forEach(ch => {
                                            const element = document.getElementById(`deviceModel${ch}`);
                                            if (element) {
                                                element.value = deviceModel[ch] || '';
                                            }
                                        });
                                    } else {
                                        // 舊格式：單一字符串，放入第一個頻道
                                        const firstChannel = getCurrentChannels()[0];
                                        if (firstChannel) {
                                            const element = document.getElementById(`deviceModel${firstChannel}`);
                                            if (element) {
                                                element.value = deviceModel || '';
                                            }
                                        }
                                    }
                                }, 500); // 等待500ms讓頻道載入完成
                            } else {
                                // 沒有 MAC ID，顯示佔位符
                                displayChannelPlaceholder();
                            }
                            document.getElementById('deviceDescription').value = data.settings.device_description || '';
                            
                            // 如果已有設定，啟用儀表板按鈕
                            if (data.settings.device_name) {
                                document.getElementById('dashboardBtn').disabled = false;
                            }
                        }
                    }
                }
            } catch (error) {
                console.warn('無法載入現有設定:', error);
            }
        }
        
        // 根據 MAC ID 載入設備設定
        async function loadDeviceByMacId(macId) {
            try {
                // 先從設備 API 獲取該設備的詳細資訊
                const devicesResponse = await fetch('/api/dashboard/devices');
                if (!devicesResponse.ok) {
                    throw new Error('無法獲取設備列表');
                }
                
                const devicesData = await devicesResponse.json();
                if (!devicesData.success) {
                    throw new Error(devicesData.message || '獲取設備列表失敗');
                }
                
                // 找到對應的設備
                const targetDevice = devicesData.devices.find(device => device.mac_id === macId);
                if (!targetDevice) {
                    throw new Error(`找不到 MAC ID 為 ${macId} 的設備`);
                }
                
                // 載入該設備的設定資訊
                document.getElementById('deviceName').value = targetDevice.device_name || '';
                document.getElementById('deviceLocation').value = targetDevice.device_location || '';
                document.getElementById('deviceDescription').value = targetDevice.device_description || '';
                
                // 等待 MAC ID 列表載入完成後再設定選中的值
                await loadMacIdList();
                
                // 設定選中的 MAC ID
                const deviceSerialSelect = document.getElementById('deviceSerial');
                deviceSerialSelect.value = macId;
                
                // 載入該 MAC ID 的頻道資訊
                await loadChannelsForMacId(macId);
                
                // 等待頻道載入完成後，填入各頻道的型號
                setTimeout(() => {
                    const deviceModel = targetDevice.device_model || '';
                    if (typeof deviceModel === 'object') {
                        // 新格式：多頻道對象
                        getCurrentChannels().forEach(ch => {
                            const element = document.getElementById(`deviceModel${ch}`);
                            if (element) {
                                element.value = deviceModel[ch] || '';
                            }
                        });
                    } else {
                        // 舊格式：單一字符串，放入第一個頻道
                        const firstChannel = getCurrentChannels()[0];
                        if (firstChannel) {
                            const element = document.getElementById(`deviceModel${firstChannel}`);
                            if (element) {
                                element.value = deviceModel || '';
                            }
                        }
                    }
                }, 500); // 等待500ms讓頻道載入完成
                
                // 如果有設備名稱，啟用儀表板按鈕
                if (targetDevice.device_name) {
                    document.getElementById('dashboardBtn').disabled = false;
                }
                
                // 顯示成功訊息
                const deviceDisplayName = targetDevice.device_name || `設備 (${macId})`;
                console.log(`成功載入設備設定: ${deviceDisplayName}`);
                
                // 可選：顯示提示訊息
                const messageDiv = document.createElement('div');
                messageDiv.className = 'alert alert-info alert-dismissible fade show mt-3';
                messageDiv.innerHTML = `
                    <strong>已自動載入設備設定</strong><br>
                    正在編輯設備: <strong>${deviceDisplayName}</strong> (MAC ID: ${macId})
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // 在表單前插入提示訊息
                const form = document.getElementById('deviceSettingForm');
                form.parentNode.insertBefore(messageDiv, form);
                
                // 3秒後自動隱藏訊息
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 5000);
                
            } catch (error) {
                console.error('載入指定設備設定失敗:', error);
                alert(`載入設備設定失敗: ${error.message}\n\n將改為載入一般設定。`);
                
                // 載入失敗時，回到一般設定載入模式
                const response = await fetch('/api/device-settings');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('deviceName').value = data.settings.device_name || '';
                        document.getElementById('deviceLocation').value = data.settings.device_location || '';
                        document.getElementById('deviceModel').value = data.settings.device_model || '';
                        document.getElementById('deviceSerial').value = data.settings.device_serial || '';
                        document.getElementById('deviceDescription').value = data.settings.device_description || '';
                        
                        if (data.settings.device_name) {
                            document.getElementById('dashboardBtn').disabled = false;
                        }
                    }
                }
            }
        }

        // 獲取MAC ID列表
        async function loadMacIdList() {
            try {
                document.getElementById('macIdStatus').textContent = '載入中...';
                
                const response = await fetch('/api/uart/mac-ids');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.mac_ids) {
                        updateMacIdOptions(data.mac_ids);
                        document.getElementById('macIdStatus').textContent = `已載入 ${data.mac_ids.length} 個 MAC ID`;
                    } else {
                        document.getElementById('macIdStatus').textContent = data.message || 'MAC ID 列表為空';
                    }
                } else {
                    document.getElementById('macIdStatus').textContent = 'HTTP 錯誤：' + response.status;
                }
            } catch (error) {
                console.error('載入 MAC ID 列表失敗:', error);
                document.getElementById('macIdStatus').textContent = '載入失敗，請檢查網路連線';
            }
        }

        // 更新MAC ID選項
        function updateMacIdOptions(macIds) {
            const select = document.getElementById('deviceSerial');
            const currentValue = select.value;
            
            // 清除現有選項（保留預設選項）
            select.innerHTML = '<option value="">請選擇 MAC ID</option>';
            
            // 添加去重複的MAC ID選項
            const uniqueMacIds = [...new Set(macIds)];
            uniqueMacIds.forEach(macId => {
                if (macId && macId.trim()) {
                    const option = document.createElement('option');
                    option.value = macId;
                    option.textContent = macId;
                    select.appendChild(option);
                }
            });
            
            // 如果原本有選中的值且仍存在，重新選中
            if (currentValue && uniqueMacIds.includes(currentValue)) {
                select.value = currentValue;
                // 重新載入該 MAC ID 的頻道資訊
                loadChannelsForMacId(currentValue);
            }
            
            // 添加 MAC ID 選擇變更事件監聽器
            select.onchange = function() {
                const selectedMacId = this.value;
                loadChannelsForMacId(selectedMacId);
            };
        }

        // 手動刷新MAC ID列表
        function refreshMacIdList() {
            loadMacIdList();
        }

        // 預覽設定
        function previewSettings() {
            const deviceName = document.getElementById('deviceName').value || '未設定設備名稱';
            const deviceLocation = document.getElementById('deviceLocation').value;
            
            // 取得當前實際可用頻道的型號
            const deviceModels = {};
            getCurrentChannels().forEach(ch => {
                const element = document.getElementById(`deviceModel${ch}`);
                if (element) {
                    deviceModels[ch] = element.value || '未設定';
                }
            });
            
            const deviceSerialSelect = document.getElementById('deviceSerial');
            const deviceSerial = deviceSerialSelect.value || '未選擇';
            const deviceDescription = document.getElementById('deviceDescription').value || '未設定';

            // 更新預覽內容
            document.getElementById('previewDeviceName').textContent = deviceName;
            document.getElementById('previewLocation').textContent = deviceLocation ? ` | ${deviceLocation}` : '';
            document.getElementById('previewNameDetail').textContent = deviceName;
            document.getElementById('previewLocationDetail').textContent = deviceLocation || '未設定';
            
            // 顯示第一個有內容的頻道型號作為主要顯示
            let mainModel = '未設定';
            for (const ch of getCurrentChannels()) {
                if (deviceModels[ch] && deviceModels[ch] !== '未設定') {
                    mainModel = `頻道 ${ch}: ${deviceModels[ch]}`;
                    break;
                }
            }
            document.getElementById('previewModelDetail').textContent = mainModel;
            document.getElementById('previewSerialDetail').textContent = deviceSerial;
            document.getElementById('previewDescriptionDetail').textContent = deviceDescription;
            
            // 顯示預覽區域
            document.getElementById('previewSection').style.display = 'block';
            
            // 滾動到預覽區域
            document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
        }

        // 重置表單
        function resetForm() {
            if (confirm('確定要重置所有設定嗎？')) {
                document.getElementById('deviceSettingForm').reset();
                document.getElementById('previewSection').style.display = 'none';
                document.getElementById('dashboardBtn').disabled = true;
                // 重置頻道顯示
                displayChannelPlaceholder();
            }
        }

        // 載入預設設定
        function loadDefaultSettings() {
            document.getElementById('deviceName').value = '預設設備';
            document.getElementById('deviceLocation').value = '生產線A區';
            
            // 為預設設定選擇第一個可用的MAC ID（如果有的話）
            const selectElement = document.getElementById('deviceSerial');
            if (selectElement.options.length > 1) {
                selectElement.selectedIndex = 1; // 選擇第一個MAC ID（跳過"請選擇"選項）
                const selectedMacId = selectElement.value;
                
                // 載入該 MAC ID 的頻道資訊，然後填入預設型號
                loadChannelsForMacId(selectedMacId).then(() => {
                    setTimeout(() => {
                        getCurrentChannels().forEach(ch => {
                            const element = document.getElementById(`deviceModel${ch}`);
                            if (element) {
                                element.value = `Standard Model CH${ch}`;
                            }
                        });
                    }, 500);
                });
            } else {
                // 如果沒有MAC ID，顯示提示
                alert('尚未載入MAC ID列表，請先啟動UART或點擊重新整理按鈕');
                return;
            }
            
            document.getElementById('deviceDescription').value = '這是系統預設的設備設定';
            
            alert('已載入預設設定，請檢查並儲存');
        }

        // 匯出設定
        function exportSettings() {
            // 收集當前實際可用頻道的型號
            const deviceModels = {};
            getCurrentChannels().forEach(ch => {
                const element = document.getElementById(`deviceModel${ch}`);
                if (element) {
                    deviceModels[ch] = element.value.trim();
                }
            });
            
            const settings = {
                device_name: document.getElementById('deviceName').value,
                device_location: document.getElementById('deviceLocation').value,
                device_model: deviceModels,
                device_serial: document.getElementById('deviceSerial').value,
                device_description: document.getElementById('deviceDescription').value,
                channel_info: {
                    current_channels: getCurrentChannels(),
                    total_channels: getCurrentChannels().length
                },
                export_time: new Date().toISOString()
            };

            const dataStr = JSON.stringify(settings, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `device_settings_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            link.click();
        }

        // 前往儀表板
        function goToDashboard() {
            window.location.href = '/dashboard';
        }

        // 表單提交處理
        document.getElementById('deviceSettingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const deviceName = document.getElementById('deviceName').value.trim();
            if (!deviceName) {
                alert('請輸入設備名稱！');
                return;
            }

            // 檢查是否需要重定向到 dashboard
            const urlParams = new URLSearchParams(window.location.search);
            const shouldRedirectToDashboard = urlParams.get('redirect') === 'true';
            
            // 收集當前實際可用頻道的型號
            const deviceModels = {};
            getCurrentChannels().forEach(ch => {
                const element = document.getElementById(`deviceModel${ch}`);
                if (element) {
                    deviceModels[ch] = element.value.trim();
                }
            });
            
            const settings = {
                device_name: deviceName,
                device_location: document.getElementById('deviceLocation').value.trim(),
                device_model: deviceModels,
                device_serial: document.getElementById('deviceSerial').value.trim(),
                device_description: document.getElementById('deviceDescription').value.trim(),
                redirect_to_dashboard: shouldRedirectToDashboard
            };

            try {
                const response = await fetch('/api/device-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('設定儲存成功！');
                    document.getElementById('dashboardBtn').disabled = false;
                    
                    // 檢查後端是否提供了重定向 URL
                    if (data.redirect_url) {
                        console.log('後端提供重定向 URL:', data.redirect_url);
                        window.location.href = data.redirect_url;
                    } else {
                        // 自動跳轉到 dashboard 頁面
                        setTimeout(() => {
                            window.location.href = '/dashboard';
                        }, 1000); // 1秒後跳轉，讓用戶看到成功訊息
                    }
                    
                } else {
                    alert('儲存失敗：' + (data.message || '未知錯誤'));
                    console.error('設定儲存失敗:', data);
                }
            } catch (error) {
                console.error('儲存設定時發生錯誤:', error);
                alert('儲存設定時發生錯誤，請稍後再試。\n錯誤詳情：' + error.message);
                
                // 如果是網路錯誤，建議檢查伺服器狀態
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    alert('無法連接到伺服器，請檢查：\n1. Flask 應用程式是否正在運行\n2. 網路連接是否正常\n3. 伺服器地址是否正確');
                }
            }
        });

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
            
            // 先載入 MAC ID 列表，然後載入現有設定
            loadMacIdList().then(() => {
                loadExistingSettings();
            });
            
            // 監聽輸入變化以即時啟用/停用按鈕
            document.getElementById('deviceName').addEventListener('input', function() {
                const hasDeviceName = this.value.trim().length > 0;
                document.getElementById('dashboardBtn').disabled = !hasDeviceName;
            });
        });
    </script>
</body>
</html>
